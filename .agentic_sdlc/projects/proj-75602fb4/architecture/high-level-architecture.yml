# =============================================================================
# High-Level Architecture - Sistema de Alertas B3
# =============================================================================
# Project: proj-75602fb4
# Phase: 2 - Architecture & Design
# Created: 2026-01-17T15:47:33Z
# Author: system-architect
# Status: proposed
# =============================================================================

architecture:
  metadata:
    project_id: proj-75602fb4
    project_name: "Sistema de Alertas B3"
    version: "1.0.0"
    created_at: "2026-01-17T15:47:33Z"
    updated_at: "2026-01-17T15:47:33Z"
    author: system-architect
    status: proposed

  # ---------------------------------------------------------------------------
  # ARCHITECTURAL PATTERN
  # ---------------------------------------------------------------------------
  pattern:
    primary: "Event-Driven Modular Monolith"
    rationale: |
      Para o MVP, um monolito modular com comunicacao por eventos internos oferece:
      - Simplicidade de deployment e operacao
      - Menor custo de infraestrutura
      - Desenvolvimento mais rapido
      - Facilidade de debugging
      - Caminho claro para microservicos se necessario

      A arquitetura event-driven interna permite:
      - Desacoplamento entre modulos
      - Processamento assincrono de alertas
      - Escalabilidade futura para workers separados

    alternatives_considered:
      - name: "Microservices"
        rejected_because: |
          Overhead de infraestrutura e operacao muito alto para MVP.
          Equipe pequena, sem necessidade de deploy independente inicial.
          Custo de orquestracao (Kubernetes) nao justificado.

      - name: "Monolith Tradicional"
        rejected_because: |
          Falta de desacoplamento dificulta evolucao.
          Acoplamento forte entre modulos cria fragilidade.
          Dificil extrair servicos futuramente.

      - name: "Serverless (Lambda/Functions)"
        rejected_because: |
          Cold start problematico para requisito de <30s de latencia.
          Complexidade de orquestracao para processamento continuo.
          Vendor lock-in em cloud provider.
          Custo pode ser maior para processamento constante durante pregao.

  # ---------------------------------------------------------------------------
  # ARCHITECTURAL PRINCIPLES
  # ---------------------------------------------------------------------------
  principles:
    - id: ARCH-PRINC-001
      name: "Modular Boundaries"
      description: |
        Cada modulo tem responsabilidade clara e se comunica com outros
        via interfaces bem definidas (eventos ou APIs internas).

    - id: ARCH-PRINC-002
      name: "Event-First Communication"
      description: |
        Operacoes que podem ser assincronas usam eventos.
        Apenas queries sincrona usam chamadas diretas.

    - id: ARCH-PRINC-003
      name: "Fail-Safe Defaults"
      description: |
        Em caso de falha, sistema degrada graciosamente.
        Dados em cache sao usados se API externa falhar.

    - id: ARCH-PRINC-004
      name: "Observable by Design"
      description: |
        Metricas, logs e traces integrados desde o inicio.
        Cada operacao critica e instrumentada.

    - id: ARCH-PRINC-005
      name: "Security by Default"
      description: |
        Autenticacao obrigatoria para todas as APIs.
        Dados sensiveis criptografados em repouso e transito.

  # ---------------------------------------------------------------------------
  # SYSTEM CONTEXT (C4 Level 1)
  # ---------------------------------------------------------------------------
  context:
    system_name: "Sistema de Alertas B3"
    description: |
      Plataforma SaaS que monitora volatilidade de ativos da B3 e envia
      alertas personalizados para investidores quando thresholds sao atingidos.

    actors:
      - id: ACTOR-INVESTOR
        name: "Investidor"
        type: person
        description: "Usuario final que configura alertas e recebe notificacoes"

      - id: ACTOR-ADMIN
        name: "Administrador"
        type: person
        description: "Operador do sistema para monitoramento e configuracao"

    external_systems:
      - id: EXT-ALPHAVANTAGE
        name: "Alpha Vantage API"
        type: external_service
        description: "Fonte de dados OHLC e metricas pre-calculadas"
        protocol: "HTTPS/REST"
        rate_limit: "5 calls/min, 500 calls/dia"

      - id: EXT-EMAIL
        name: "Email Service (SendGrid/SES)"
        type: external_service
        description: "Servico de envio de emails transacionais"
        protocol: "HTTPS/API"

      - id: EXT-PUSH
        name: "Web Push Service"
        type: external_service
        description: "Firebase Cloud Messaging ou similar para push notifications"
        protocol: "HTTPS/API"

      - id: EXT-SMS
        name: "SMS Gateway (Twilio/Zenvia)"
        type: external_service
        description: "Gateway de SMS para notificacoes premium"
        protocol: "HTTPS/API"
        tier: premium

      - id: EXT-TELEGRAM
        name: "Telegram Bot API"
        type: external_service
        description: "API do Telegram para bot de notificacoes"
        protocol: "HTTPS/API"
        tier: premium

      - id: EXT-PAYMENT
        name: "Payment Gateway (Stripe)"
        type: external_service
        description: "Processamento de pagamentos para tier premium"
        protocol: "HTTPS/API"

  # ---------------------------------------------------------------------------
  # CONTAINER VIEW (C4 Level 2)
  # ---------------------------------------------------------------------------
  containers:
    - id: CONT-WEBAPP
      name: "Web Application (SPA/PWA)"
      type: web_application
      technology: "Next.js / React"
      description: |
        Dashboard web para visualizacao de metricas, configuracao de alertas
        e gestao de watchlists. PWA instalavel em mobile.
      responsibilities:
        - "Exibir metricas de volatilidade"
        - "Interface de configuracao de alertas"
        - "Watchlist de ativos"
        - "Autenticacao de usuarios"
        - "Receber push notifications"
      ports:
        - port: 3000
          protocol: HTTPS
          public: true

    - id: CONT-API
      name: "Backend API"
      type: api
      technology: ".NET 8 / ASP.NET Core"
      description: |
        API REST que expoe todas as funcionalidades do sistema.
        Organizada em modulos internos para cada dominio.
      responsibilities:
        - "Autenticacao e autorizacao"
        - "CRUD de alertas"
        - "Exposicao de metricas"
        - "Gestao de usuarios e watchlists"
        - "Integracao com payment gateway"
      ports:
        - port: 8080
          protocol: HTTPS
          public: true
          path_prefix: "/api/v1"

    - id: CONT-WORKER
      name: "Background Worker"
      type: worker
      technology: ".NET 8 / Worker Service"
      description: |
        Processo em background que executa ingestao de dados,
        calculo de metricas e avaliacao de regras de alertas.
      responsibilities:
        - "Ingestao de dados da Alpha Vantage"
        - "Calculo de metricas de volatilidade"
        - "Avaliacao de regras de alertas"
        - "Enfileiramento de notificacoes"
      scaling: "Horizontal via worker pool"
      schedule: "A cada 5 minutos durante pregao"

    - id: CONT-NOTIFIER
      name: "Notification Service"
      type: worker
      technology: ".NET 8 / Worker Service"
      description: |
        Servico que consome fila de notificacoes e envia
        via canais apropriados (email, push, SMS, Telegram).
      responsibilities:
        - "Consumir fila de alertas disparados"
        - "Enviar emails via SendGrid/SES"
        - "Enviar push notifications"
        - "Enviar SMS (premium)"
        - "Enviar mensagens Telegram (premium)"
      resilience:
        - "Retry com backoff exponencial"
        - "Dead letter queue para falhas"

    - id: CONT-DATABASE
      name: "PostgreSQL Database"
      type: database
      technology: "PostgreSQL 16"
      description: |
        Banco de dados relacional principal para usuarios, alertas,
        e dados de mercado historicos.
      responsibilities:
        - "Armazenar usuarios e preferencias"
        - "Armazenar configuracoes de alertas"
        - "Armazenar historico de alertas disparados"
        - "Armazenar dados OHLC e metricas calculadas"
        - "Armazenar watchlists"
      scaling: "Read replicas se necessario"
      backup: "Daily, 30 dias retencao"

    - id: CONT-CACHE
      name: "Redis Cache"
      type: cache
      technology: "Redis 7"
      description: |
        Cache para dados de mercado, sessoes e rate limiting.
      responsibilities:
        - "Cache de dados OHLC (TTL 60s intraday, 24h historico)"
        - "Cache de metricas calculadas"
        - "Sessoes de usuario"
        - "Rate limiting counters"
        - "Fila de notificacoes (Redis Streams)"
      high_availability: "Redis Sentinel para MVP, Cluster para producao"

    - id: CONT-MSGQUEUE
      name: "Message Queue"
      type: message_broker
      technology: "Redis Streams"
      description: |
        Fila de mensagens para comunicacao assincrona entre componentes.
        Usa Redis Streams para simplificar infraestrutura no MVP.
      responsibilities:
        - "Fila de alertas para processamento"
        - "Fila de notificacoes para envio"
        - "Eventos de atualizacao de dados"
      alternatives: "Migrar para RabbitMQ ou Kafka se escala exigir"

  # ---------------------------------------------------------------------------
  # COMPONENT VIEW (C4 Level 3) - Backend API Modules
  # ---------------------------------------------------------------------------
  api_modules:
    - id: MOD-AUTH
      name: "Authentication Module"
      description: "Autenticacao, autorizacao e gestao de sessoes"
      dependencies: ["CONT-DATABASE", "CONT-CACHE"]
      endpoints:
        - "POST /api/v1/auth/register"
        - "POST /api/v1/auth/login"
        - "POST /api/v1/auth/refresh"
        - "POST /api/v1/auth/logout"
        - "POST /api/v1/auth/forgot-password"

    - id: MOD-USERS
      name: "Users Module"
      description: "Gestao de perfil e preferencias de usuario"
      dependencies: ["MOD-AUTH", "CONT-DATABASE"]
      endpoints:
        - "GET /api/v1/users/me"
        - "PUT /api/v1/users/me"
        - "DELETE /api/v1/users/me"
        - "GET /api/v1/users/me/export"
        - "PUT /api/v1/users/me/preferences"

    - id: MOD-ASSETS
      name: "Assets Module"
      description: "Catalogo de ativos disponiveis para monitoramento"
      dependencies: ["CONT-DATABASE", "CONT-CACHE"]
      endpoints:
        - "GET /api/v1/assets"
        - "GET /api/v1/assets/{symbol}"
        - "GET /api/v1/assets/search"

    - id: MOD-VOLATILITY
      name: "Volatility Module"
      description: "Metricas de volatilidade calculadas"
      dependencies: ["CONT-DATABASE", "CONT-CACHE"]
      endpoints:
        - "GET /api/v1/volatility/{symbol}"
        - "GET /api/v1/volatility?symbols=..."
        - "GET /api/v1/volatility/{symbol}/history"

    - id: MOD-ALERTS
      name: "Alerts Module"
      description: "Configuracao e gestao de alertas"
      dependencies: ["MOD-VOLATILITY", "CONT-DATABASE"]
      endpoints:
        - "GET /api/v1/alerts"
        - "POST /api/v1/alerts"
        - "GET /api/v1/alerts/{id}"
        - "PUT /api/v1/alerts/{id}"
        - "DELETE /api/v1/alerts/{id}"
        - "POST /api/v1/alerts/{id}/pause"
        - "GET /api/v1/alerts/history"

    - id: MOD-WATCHLIST
      name: "Watchlist Module"
      description: "Gestao de listas de ativos favoritos"
      dependencies: ["MOD-ASSETS", "CONT-DATABASE"]
      endpoints:
        - "GET /api/v1/watchlist"
        - "POST /api/v1/watchlist"
        - "DELETE /api/v1/watchlist/{symbol}"

    - id: MOD-SUBSCRIPTION
      name: "Subscription Module"
      description: "Gestao de assinaturas e pagamentos"
      dependencies: ["EXT-PAYMENT", "CONT-DATABASE"]
      endpoints:
        - "GET /api/v1/subscription"
        - "POST /api/v1/subscription/checkout"
        - "POST /api/v1/subscription/webhook"
        - "POST /api/v1/subscription/cancel"

  # ---------------------------------------------------------------------------
  # WORKER MODULES
  # ---------------------------------------------------------------------------
  worker_modules:
    - id: WMOD-INGESTION
      name: "Data Ingestion Module"
      description: "Ingestao de dados da Alpha Vantage"
      schedule: "Every 5 minutes during market hours (10h-17h BRT)"
      responsibilities:
        - "Buscar dados OHLC de ativos monitorados"
        - "Respeitar rate limits (5 calls/min)"
        - "Priorizar ativos com alertas ativos"
        - "Armazenar em cache e banco"
      dependencies: ["EXT-ALPHAVANTAGE", "CONT-CACHE", "CONT-DATABASE"]

    - id: WMOD-CALCULATOR
      name: "Metrics Calculator Module"
      description: "Calculo de metricas de volatilidade"
      trigger: "Apos ingestion ou on-demand"
      responsibilities:
        - "Calcular ATR(14)"
        - "Calcular Desvio Padrao (30 dias)"
        - "Calcular Bollinger Bands (premium)"
        - "Calcular Beta vs Ibovespa (premium)"
        - "Cachear resultados"
      dependencies: ["CONT-DATABASE", "CONT-CACHE"]

    - id: WMOD-EVALUATOR
      name: "Alert Evaluator Module"
      description: "Avaliacao de regras de alertas"
      trigger: "Apos calculo de metricas"
      responsibilities:
        - "Carregar regras de alertas ativos"
        - "Avaliar condicoes contra metricas atuais"
        - "Detectar alertas a disparar"
        - "Aplicar cooldown e dedup"
        - "Enfileirar alertas para notificacao"
      dependencies: ["CONT-DATABASE", "CONT-CACHE", "CONT-MSGQUEUE"]
      performance:
        target: "10.000 regras em < 10 segundos"

  # ---------------------------------------------------------------------------
  # DATA FLOW
  # ---------------------------------------------------------------------------
  data_flows:
    - id: FLOW-001
      name: "Market Data Ingestion"
      description: "Fluxo de ingestao de dados de mercado"
      steps:
        - "1. Scheduler dispara ciclo de ingestao (5 min)"
        - "2. Worker prioriza ativos com alertas ativos"
        - "3. Worker chama Alpha Vantage (respeitando rate limit)"
        - "4. Dados OHLC sao armazenados em cache (Redis) e banco (PostgreSQL)"
        - "5. Evento 'MarketDataUpdated' e publicado"

    - id: FLOW-002
      name: "Volatility Calculation"
      description: "Fluxo de calculo de metricas"
      trigger: "Evento 'MarketDataUpdated'"
      steps:
        - "1. Calculator recebe evento de dados atualizados"
        - "2. Calcula ATR, Desvio Padrao, etc. para cada ativo atualizado"
        - "3. Armazena metricas em cache e banco"
        - "4. Evento 'MetricsCalculated' e publicado"

    - id: FLOW-003
      name: "Alert Evaluation"
      description: "Fluxo de avaliacao de alertas"
      trigger: "Evento 'MetricsCalculated'"
      steps:
        - "1. Evaluator recebe evento de metricas calculadas"
        - "2. Carrega regras de alertas ativos para o ativo"
        - "3. Avalia cada regra contra metricas atuais"
        - "4. Verifica cooldown e dedup"
        - "5. Alertas disparados sao enfileirados em 'notifications_queue'"

    - id: FLOW-004
      name: "Notification Delivery"
      description: "Fluxo de envio de notificacoes"
      trigger: "Mensagem em 'notifications_queue'"
      steps:
        - "1. Notifier consome fila de notificacoes"
        - "2. Identifica canais configurados pelo usuario"
        - "3. Envia via cada canal (email, push, SMS, Telegram)"
        - "4. Registra resultado em historico"
        - "5. Retry com backoff em caso de falha"

  # ---------------------------------------------------------------------------
  # RESILIENCE PATTERNS
  # ---------------------------------------------------------------------------
  resilience:
    patterns:
      - name: "Circuit Breaker"
        applies_to: ["EXT-ALPHAVANTAGE", "EXT-EMAIL", "EXT-SMS"]
        description: |
          Se servico externo falhar X vezes consecutivas, circuito abre
          e chamadas falham rapidamente por Y segundos antes de tentar novamente.
        config:
          failure_threshold: 3
          recovery_timeout: 30s

      - name: "Retry with Exponential Backoff"
        applies_to: ["notifications", "api_calls"]
        description: "Retry com backoff exponencial para falhas transientes"
        config:
          max_retries: 3
          initial_delay: 1s
          max_delay: 30s

      - name: "Fallback to Cache"
        applies_to: ["market_data"]
        description: |
          Se Alpha Vantage estiver indisponivel, usar dados em cache.
          Alertar usuario sobre dados potencialmente desatualizados.

      - name: "Bulkhead"
        applies_to: ["workers"]
        description: |
          Isolar workers para que falha em um nao afete outros.
          Pool separado para ingestion vs notification.

      - name: "Dead Letter Queue"
        applies_to: ["notifications"]
        description: |
          Notificacoes que falharem apos max_retries vao para DLQ
          para analise e reprocessamento manual.

  # ---------------------------------------------------------------------------
  # SCALING STRATEGY
  # ---------------------------------------------------------------------------
  scaling:
    mvp:
      description: "Single instance de cada componente, vertical scaling"
      components:
        api: "1 instance"
        worker: "1 instance"
        notifier: "1 instance"
        database: "1 instance (PostgreSQL)"
        cache: "1 instance (Redis)"
      capacity: "~100 usuarios, ~500 alertas ativos"

    growth:
      description: "Horizontal scaling de workers, read replicas"
      components:
        api: "2-4 instances (load balanced)"
        worker: "2-3 instances (partitioned by asset)"
        notifier: "2 instances"
        database: "1 primary + 1 read replica"
        cache: "Redis Sentinel (3 nodes)"
      capacity: "~1.000 usuarios, ~5.000 alertas ativos"

    enterprise:
      description: "Full Kubernetes, multi-region, auto-scaling"
      components:
        api: "Auto-scaled pods (HPA)"
        worker: "Auto-scaled pods"
        notifier: "Auto-scaled pods"
        database: "Managed PostgreSQL (RDS/Azure SQL)"
        cache: "Managed Redis (ElastiCache/Azure Cache)"
      capacity: "10.000+ usuarios, 50.000+ alertas ativos"

  # ---------------------------------------------------------------------------
  # DEPLOYMENT VIEW
  # ---------------------------------------------------------------------------
  deployment:
    environments:
      - name: "Development"
        infrastructure: "Local (Docker Compose)"
        purpose: "Desenvolvimento e testes locais"

      - name: "Staging"
        infrastructure: "Single container host (Azure Container Instance / AWS ECS)"
        purpose: "Testes de integracao e validacao pre-producao"

      - name: "Production"
        infrastructure: "Container orchestration (Azure Container Apps / AWS App Runner)"
        purpose: "Ambiente de producao"

    container_strategy:
      runtime: "Docker"
      orchestration_mvp: "Docker Compose / Single Host"
      orchestration_growth: "Azure Container Apps / AWS App Runner"
      orchestration_enterprise: "Kubernetes (AKS/EKS)"

  # ---------------------------------------------------------------------------
  # CROSS-CUTTING CONCERNS
  # ---------------------------------------------------------------------------
  cross_cutting:
    observability:
      logging:
        format: "JSON structured"
        sink: "Loki / CloudWatch Logs"
        correlation: "Request ID propagado entre servicos"

      metrics:
        format: "Prometheus / OpenMetrics"
        sink: "Prometheus + Grafana"
        key_metrics:
          - "api_request_duration_seconds"
          - "alert_evaluation_duration_seconds"
          - "notification_delivery_duration_seconds"
          - "cache_hit_ratio"
          - "active_alerts_count"

      tracing:
        protocol: "OpenTelemetry"
        sink: "Jaeger / Tempo"
        sampled: "100% for errors, 10% for success"

    security:
      authentication: "JWT with RS256 (asymmetric)"
      authorization: "Role-based (free/premium/admin)"
      encryption_transit: "TLS 1.3"
      encryption_rest: "AES-256 for sensitive data"
      secrets_management: "Environment variables / Azure Key Vault"

    configuration:
      source: "Environment variables"
      secrets: "Azure Key Vault / AWS Secrets Manager"
      feature_flags: "Simple config-based (no external service for MVP)"

  # ---------------------------------------------------------------------------
  # TECHNICAL DEBT & FUTURE IMPROVEMENTS
  # ---------------------------------------------------------------------------
  technical_debt:
    accepted:
      - id: TD-001
        description: "Redis Streams ao inves de message broker dedicado"
        rationale: "Simplifica infraestrutura para MVP"
        migration_path: "Migrar para RabbitMQ se volume exigir"

      - id: TD-002
        description: "Monolito modular ao inves de microservicos"
        rationale: "Menor overhead operacional para equipe pequena"
        migration_path: "Extrair servicos conforme necessidade"

      - id: TD-003
        description: "Single region deployment"
        rationale: "Usuarios concentrados no Brasil, custo de multi-region alto"
        migration_path: "Adicionar CDN e multi-region se expandir"

  # ---------------------------------------------------------------------------
  # RELATED DECISIONS
  # ---------------------------------------------------------------------------
  related_adrs:
    - adr-001  # Alpha Vantage como fonte de dados
    - adr-002  # Modelo Freemium
    - adr-003  # Priorizacao de metricas
    - adr-004  # Este ADR - Arquitetura Event-Driven Modular Monolith
