decision:
  id: adr-009
  type: architectural
  title: "Controles de Seguranca baseados em Threat Model STRIDE"
  created_at: '2026-01-17T16:02:18Z'
  status: accepted

  context: |
    Apos threat modeling usando STRIDE, identificamos 15 ameacas
    com 3 criticas, 5 altas, 6 medias e 1 baixa.

    Principais areas de risco:
    - Autenticacao e gestao de sessoes
    - Controle de acesso (IDOR, privilege escalation)
    - Protecao de dados (PII, LGPD)
    - Disponibilidade (DDoS, rate limiting)

    Precisamos definir controles de seguranca prioritarios para MVP.

  decision: |
    Implementar os seguintes controles de seguranca para o MVP:

    1. **Autenticacao e Sessoes (Alta Prioridade):**
       - JWT com RS256 (asymmetric keys)
       - Access token: 15 min expiracao
       - Refresh token: 7 dias, HttpOnly cookie, rotation
       - Rate limiting: 5 tentativas login em 15 min por IP
       - CAPTCHA apos 3 falhas consecutivas

    2. **Controle de Acesso (Alta Prioridade):**
       - Ownership verification em todas as operacoes
       - Role-based access control (free/premium/admin)
       - IDs opacos (UUID v4)
       - Tier verification no backend a cada request

    3. **Protecao de Dados (Critica):**
       - TLS 1.3 para dados em transito
       - Encryption at rest (PostgreSQL TDE)
       - Passwords com bcrypt (cost 12)
       - Data masking em logs (email, telefone)
       - Secrets em Azure Key Vault

    4. **Prevencao de Injection (Critica):**
       - Parameterized queries (Entity Framework)
       - Input validation (FluentValidation)
       - Output encoding para prevenir XSS
       - CSP headers rigorosos

    5. **Rate Limiting e DDoS (Alta):**
       - 60 req/min para free tier
       - 600 req/min para premium tier
       - WAF rules (Azure WAF ou Cloudflare)
       - CDN para absorver trafego

    6. **Auditoria e Monitoramento (Media):**
       - Audit log para modificacoes de dados
       - Login anomaly detection
       - Alertas para tentativas de ataque
       - Log retention: 90 dias

  consequences:
    positive:
      - "Mitigacao de 15 ameacas identificadas"
      - "Conformidade com LGPD"
      - "Protecao contra ataques comuns (OWASP Top 10)"
      - "Base solida para expansao de seguranca"

    negative:
      - "Overhead de performance (rate limiting, encryption)"
      - "Complexidade adicional de desenvolvimento"
      - "Custo de Azure Key Vault"

    risks:
      - risk: "Falsos positivos em rate limiting bloqueiam usuarios legitimos"
        probability: low
        mitigation: "Thresholds generosos, monitoramento, ajuste dinamico"

  alternatives:
    - name: "Seguranca minima (apenas autenticacao)"
      rejected_because: |
        Risco muito alto de violacao de dados.
        Nao atende requisitos de LGPD.

    - name: "Seguranca maxima (todas as best practices)"
      rejected_because: |
        Overhead de desenvolvimento muito alto para MVP.
        Custo de infraestrutura elevado.
        Implementar incrementalmente.

  phase: 2
  author: threat-modeler
  approvers: []

  metadata:
    complexity: high
    reversible: true
    cost_impact: "~$20-50/mes adicional (Key Vault, WAF)"
    security_impact: "Positivo - protecao contra maioria dos ataques"

  supersedes: null
